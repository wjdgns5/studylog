<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout :: layout(~{::body})}">
    <meta charset="UTF-8">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body class="container mt-5">

<h2 class="mb-4">ë§ˆì´í˜ì´ì§€</h2>

<div class="mb-3 d-flex justify-content-between">
    <div>
        <a href="/" class="btn btn-outline-secondary btn-sm">ê³µê°œ ê¸€ ëª©ë¡</a>
    </div>
    <div>
        <!-- ğŸ”¹ ìƒˆ ê¸€ ì‘ì„± ë²„íŠ¼ -->
        <a href="/posts/new" class="btn btn-primary btn-sm">ìƒˆ ê¸€ ì‘ì„±</a>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <h4>í”„ë¡œí•„</h4>
        <ul class="list-group">
            <li class="list-group-item">
                <strong>ì´ë©”ì¼: </strong><span id="profile-email"></span>
            </li>
            <li class="list-group-item">
                <strong>ê°€ì…ì¼: </strong><span id="profile-joinedAt"></span>
            </li>
            <li class="list-group-item">
                <strong>ì „ì²´ ê¸€: </strong><span id="profile-total"></span>
            </li>
            <li class="list-group-item">
                <strong>ê³µê°œ ê¸€: </strong><span id="profile-public"></span>
            </li>
            <li class="list-group-item">
                <strong>ë¹„ê³µê°œ ê¸€: </strong><span id="profile-private"></span>
            </li>
        </ul>
    </div>

    <div class="col-md-8">
        <h4>ë‚´ ê¸€ ëª©ë¡</h4>
        <div id="my-posts" class="mb-4">
            <!-- ë‚´ ê¸€ ë¦¬ìŠ¤íŠ¸ -->
        </div>

        <h4>ë¶ë§ˆí¬í•œ ê¸€</h4>
        <div id="my-bookmarks">
            <!-- ë¶ë§ˆí¬ ë¦¬ìŠ¤íŠ¸ -->
        </div>
    </div>
</div>

<script>
    // ğŸ”¹ ê³µí†µ fetch í—¬í¼ (JWT ìë™ í—¤ë” ì¶”ê°€)
    async function apiFetch(url, options = {}) {
        const token = localStorage.getItem('accessToken');

        const headers = options.headers || {};
        if (token) {
            headers['Authorization'] = 'Bearer ' + token;
        }
        if (!headers['Content-Type'] && options.body) {
            headers['Content-Type'] = 'application/json';
        }

        const response = await fetch(url, {
            ...options,
            headers
        });

        if (!response.ok) {
            const text = await response.text();
            try {
                const err = JSON.parse(text);
                alert('ì—ëŸ¬: ' + err.message);
            } catch (e) {
                alert('ìš”ì²­ ì‹¤íŒ¨: ' + response.status);
            }
            throw new Error('Request failed: ' + response.status);
        }

        if (response.status === 204) {
            return null;
        }

        return response.json();
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        try {
            // ğŸ”¹ í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const profile = await apiFetch('/api/users/me/profile');
            document.getElementById('profile-email').innerText = profile.email;
            document.getElementById('profile-joinedAt').innerText =
                (profile.joinedAt || '').replace('T', ' ');
            document.getElementById('profile-total').innerText = profile.totalPosts;
            document.getElementById('profile-public').innerText = profile.publicPosts;
            document.getElementById('profile-private').innerText = profile.privatePosts;

            // ğŸ”¹ ë‚´ ê¸€ ëª©ë¡
            const myPosts = await apiFetch('/api/posts/me');
            const postsDiv = document.getElementById('my-posts');
            if (!myPosts || myPosts.length === 0) {
                postsDiv.innerHTML = '<p class="text-muted">ì‘ì„±í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                myPosts.forEach(post => {
                    const div = document.createElement('div');
                    div.className = 'card mb-2';
                    div.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">
                              <a href="/posts/${post.id}">${post.title}</a>
                              ${post.private ? '<span class="badge badge-secondary">ë¹„ê³µê°œ</span>' : ''}
                            </h5>
                            <h6 class="card-subtitle mb-2 text-muted">
                              ${post.category || ''} | ${post.tags || ''}
                            </h6>
                        </div>
                    `;
                    postsDiv.appendChild(div);
                });
            }

            // ğŸ”¹ ë¶ë§ˆí¬ ëª©ë¡
            const bookmarks = await apiFetch('/api/bookmarks/me');
            const bookmarksDiv = document.getElementById('my-bookmarks');
            if (!bookmarks || bookmarks.length === 0) {
                bookmarksDiv.innerHTML = '<p class="text-muted">ë¶ë§ˆí¬í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                bookmarks.forEach(post => {
                    const div = document.createElement('div');
                    div.className = 'card mb-2';
                    div.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">
                              <a href="/posts/${post.id}">${post.title}</a>
                            </h5>
                            <h6 class="card-subtitle mb-2 text-muted">
                              ${post.category || ''} | ${post.tags || ''}
                            </h6>
                        </div>
                    `;
                    bookmarksDiv.appendChild(div);
                });
            }

        } catch (e) {
            console.error(e);
        }
    });
</script>

</body>
</html>
