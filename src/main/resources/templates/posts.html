<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout :: layout(~{::body})}">
<head>
    <title>ê³µê°œ ê¸€ ëª©ë¡ - StudyLog</title>
</head>
<body class="mt-4">

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2 class="mb-1">ğŸ“š ê³µê°œ ê¸€ ëª©ë¡</h2>
        <small class="text-muted">
            ë‹¤ë¥¸ ì‚¬ëŒë“¤ì˜ ê³µë¶€ ê¸°ë¡ì„ ë³´ë©´ì„œ ê°™ì´ ì„±ì¥í•´ ë³´ì„¸ìš”.
        </small>
    </div>
    <div>
        <a href="/mypage" class="btn btn-primary btn-sm">ë‚´ ê³µë¶€ ê¸°ë¡ ë³´ëŸ¬ê°€ê¸°</a>
    </div>
</div>

<!-- ê²€ìƒ‰ ì˜ì—­ -->
<div class="card mb-4">
    <div class="card-body">
        <form id="search-form" class="form-row">
            <div class="form-group col-md-4">
                <label for="search-keyword">í‚¤ì›Œë“œ</label>
                <input type="text" id="search-keyword" class="form-control"
                       placeholder="ì œëª©/ë‚´ìš© ê²€ìƒ‰">
            </div>
            <div class="form-group col-md-3">
                <label for="search-category">ì¹´í…Œê³ ë¦¬</label>
                <input type="text" id="search-category" class="form-control"
                       placeholder="ì˜ˆ: ìŠ¤í”„ë§, ìë°”">
            </div>
            <div class="form-group col-md-3">
                <label for="search-tag">íƒœê·¸</label>
                <input type="text" id="search-tag" class="form-control"
                       placeholder="ì˜ˆ: jwt, algorithm">
            </div>
            <div class="form-group col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-outline-primary btn-block">
                    ê²€ìƒ‰
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ê¸€ ëª©ë¡ ì˜ì—­ -->
<div id="posts-list">
    <!-- ê¸€ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
</div>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
<div class="d-flex justify-content-between align-items-center mt-4" id="pagination-area" style="display: none;">
    <button class="btn btn-outline-secondary btn-sm" id="btn-prev" onclick="prevPage()">ì´ì „</button>
    <span class="text-muted" id="page-info"></span>
    <button class="btn btn-outline-secondary btn-sm" id="btn-next" onclick="nextPage()">ë‹¤ìŒ</button>
</div>

<script>
    let currentPage = 0;
    let totalPages = 0;
    const pageSize = 10;

    function formatDateTime(dateTimeStr) {
        if (!dateTimeStr) return '';
        // "2025-12-09T12:34:56" â†’ "2025-12-09 12:34"
        return dateTimeStr.replace('T', ' ').slice(0, 16);
    }

    function renderPosts(posts) {
        const listDiv = document.getElementById('posts-list');
        listDiv.innerHTML = '';

        if (!posts || posts.length === 0) {
            listDiv.innerHTML = `
                <div class="text-center text-muted py-5">
                    ì•„ì§ ë“±ë¡ëœ ê³µê°œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
            `;
            document.getElementById('pagination-area').style.display = 'none';
            return;
        }

        posts.forEach(post => {
            const card = document.createElement('div');
            card.className = 'card mb-3';

            const tags = (post.tags || '')
                .split(',')
                .map(t => t.trim())
                .filter(t => t.length > 0)
                .map(t => `<span class="badge badge-light mr-1">#${t}</span>`)
                .join(' ');

            card.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title mb-1">
                        <a href="/posts/${post.id}">${post.title}</a>
                    </h5>
                    <h6 class="card-subtitle mb-2 text-muted">
                        ${post.category || 'ì¹´í…Œê³ ë¦¬ ì—†ìŒ'}
                        ${tags ? ' Â· ' + tags : ''}
                    </h6>
                    <p class="card-text text-truncate" style="max-width: 100%;">
                        ${post.preview || post.content || ''}
                    </p>
                    <small class="text-muted">
                        ì‘ì„±ì: ${post.authorEmail || 'ìµëª…'}
                        Â· ì‘ì„±ì¼: ${formatDateTime(post.createdAt)}
                    </small>
                </div>
            `;
            listDiv.appendChild(card);
        });
    }

    function renderPagination() {
        const area = document.getElementById('pagination-area');
        const pageInfo = document.getElementById('page-info');
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');

        if (totalPages <= 1) {
            area.style.display = 'none';
            return;
        }

        area.style.display = 'flex';
        pageInfo.innerText = `í˜ì´ì§€ ${currentPage + 1} / ${totalPages}`;

        btnPrev.disabled = currentPage === 0;
        btnNext.disabled = currentPage + 1 >= totalPages;
    }

    async function loadPosts(page = 0) {
        const keyword = document.getElementById('search-keyword').value.trim();
        const category = document.getElementById('search-category').value.trim();
        const tag = document.getElementById('search-tag').value.trim();

        const params = new URLSearchParams();
        params.set('page', page);
        params.set('size', pageSize);
        if (keyword) params.set('keyword', keyword);
        if (category) params.set('category', category);
        if (tag) params.set('tag', tag);

        const url = '/api/posts/public?' + params.toString();

        try {
            const data = await apiFetch(url); // layout.htmlì— ìˆëŠ” ê³µí†µ apiFetch ì‚¬ìš©
            // dataê°€ Spring Page í˜•íƒœë¼ê³  ê°€ì •: { content, totalPages, number, ... }
            currentPage = data.number || 0;
            totalPages = data.totalPages || 1;

            renderPosts(data.content || []);
            renderPagination();
        } catch (e) {
            console.error(e);
        }
    }

    function prevPage() {
        if (currentPage > 0) {
            loadPosts(currentPage - 1);
        }
    }

    function nextPage() {
        if (currentPage + 1 < totalPages) {
            loadPosts(currentPage + 1);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('search-form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            loadPosts(0);
        });

        loadPosts(0);
    });
</script>

</body>
</html>
